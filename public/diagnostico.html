<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Conexão - Sistema RBAC</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        header {
            background: #4a5568;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #667eea;
        }
        
        h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        h3 {
            color: #667eea;
            margin: 15px 0 10px;
            font-size: 18px;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        .test-area {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .btn {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px 5px 5px 0;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #48bb78;
        }
        
        .btn-secondary:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #f56565;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e2e8f0;
        }
        
        .success {
            color: #38a169;
            border-left: 4px solid #38a169;
        }
        
        .error {
            color: #e53e3e;
            border-left: 4px solid #e53e3e;
        }
        
        .warning {
            color: #d69e2e;
            border-left: 4px solid #d69e2e;
        }
        
        .code {
            font-family: monospace;
            background: #2d3748;
            color: #cbd5e0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
            font-weight: bold;
        }
        
        .solution {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        ul {
            padding-left: 20px;
            margin: 15px 0;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-on {
            background: #c6f6d5;
            color: #276749;
        }
        
        .status-off {
            background: #fed7d7;
            color: #c53030;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Diagnóstico de Conexão - Sistema RBAC</h1>
            <p class="description">Ferramenta para diagnosticar e resolver problemas de conexão entre frontend e backend</p>
        </header>
        
        <div class="content">
            <div class="card">
                <h2>Problema Identificado</h2>
                <p>Seu sistema está apresentando o erro "Erro ao conectar com o servidor", que geralmente está relacionado a:</p>
                <ul>
                    <li>Problemas de configuração do CORS (Cross-Origin Resource Sharing)</li>
                    <li>Servidor backend não está respondendo na porta correta</li>
                    <li>Requisições bloqueadas por políticas de segurança do navegador</li>
                    <li>Problemas na configuração das rotas da API</li>
                </ul>
            </div>
            
            <div class="card">
                <h2>Teste de Conexão</h2>
                <p>Clique no botão abaixo para testar a conexão com o servidor backend:</p>
                
                <div class="test-area">
                    <button id="test-connection" class="btn">Testar Conexão com Backend</button>
                    <div id="connection-result" class="result hidden"></div>
                </div>
                
                <div id="solutions-section">
                    <h3>Possíveis Soluções:</h3>
                    
                    <div class="step">
                        <div class="step-number">1</div>
                        <div>
                            <p><strong>Verifique se o servidor está rodando</strong></p>
                            <p>Certifique-se de que seu servidor backend está em execução na porta 3000.</p>
                            <div class="code">node server.js</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>
                            <p><strong>Configure o CORS corretamente</strong></p>
                            <p>No arquivo server.js, atualize a configuração do CORS para ser mais específica:</p>
                            <div class="code">// Substitua a configuração atual de CORS por:
app.use((req, res, next) => {
    const allowedOrigins = ['http://localhost:3000', 'http://127.0.0.1:3000'];
    const origin = req.headers.origin;
    
    if (allowedOrigins.includes(origin)) {
        res.header('Access-Control-Allow-Origin', origin);
    }
    
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization, user-role');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Credentials', true);
    
    if (req.method === 'OPTIONS') {
        return res.sendStatus(200);
    }
    
    next();
});</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>
                            <p><strong>Verifique as importações no server.js</strong></p>
                            <p>Certifique-se de que todos os módulos estão sendo importados corretamente:</p>
                            <div class="code">const authRoutes = require('./auth');
const protectedRoutes = require('./protected'); // ou './protect' dependendo do nome do arquivo
const pool = require('./database'); // Adicione esta linha se não existir</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Verificador de Configuração</h2>
                
                <div class="test-area">
                    <button id="check-config" class="btn btn-secondary">Verificar Configuração</button>
                    <div id="config-result" class="result hidden"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>Testes de API</h2>
                <p>Teste endpoints específicos da API para identificar onde está o problema:</p>
                
                <div class="test-area">
                    <button id="test-auth" class="btn">Testar Rota de Autenticação</button>
                    <button id="test-protected" class="btn">Testar Rota Protegida</button>
                    <div id="api-test-result" class="result hidden"></div>
                </div>
            </div>
            
            <div class="solution">
                <h2>Solução Recomendada</h2>
                <p>Com base na análise do seu código, o problema mais provável está na configuração do CORS. Recomendo:</p>
                <ol>
                    <li>Atualizar a configuração do CORS no server.js conforme mostrado acima</li>
                    <li>Reiniciar o servidor após a alteração</li>
                    <li>Verificar se o servidor está rodando na porta correta</li>
                    <li>Testar novamente a conexão usando os botões acima</li>
                </ol>
            </div>
        </div>
        
        <footer>
            <p>Sistema de Diagnóstico RBAC &copy; 2023</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE = 'http://localhost:3000';
            const testConnectionBtn = document.getElementById('test-connection');
            const checkConfigBtn = document.getElementById('check-config');
            const testAuthBtn = document.getElementById('test-auth');
            const testProtectedBtn = document.getElementById('test-protected');
            const connectionResult = document.getElementById('connection-result');
            const configResult = document.getElementById('config-result');
            const apiTestResult = document.getElementById('api-test-result');
            
            // Testar conexão com o backend
            testConnectionBtn.addEventListener('click', async () => {
                connectionResult.textContent = 'Testando conexão...';
                connectionResult.className = 'result';
                connectionResult.classList.remove('hidden');
                
                try {
                    const response = await fetch(`${API_BASE}/`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        connectionResult.textContent = '✅ Conexão com o backend bem-sucedida!';
                        connectionResult.classList.add('success');
                    } else {
                        connectionResult.textContent = '❌ O servidor respondeu com um erro. Verifique se está rodando corretamente.';
                        connectionResult.classList.add('error');
                    }
                } catch (error) {
                    connectionResult.innerHTML = `❌ Falha na conexão com o backend: <strong>${error.message}</strong>.
                    <br>Verifique se o servidor está rodando na porta 3000.`;
                    connectionResult.classList.add('error');
                }
            });
            
            // Verificar configuração
            checkConfigBtn.addEventListener('click', () => {
                configResult.innerHTML = `
                    <h3>Configuração Atual do Sistema:</h3>
                    <p>URL da API: <strong>${API_BASE}</strong></p>
                    <p>Endpoints esperados:</p>
                    <ul>
                        <li>POST ${API_BASE}/auth/register</li>
                        <li>POST ${API_BASE}/auth/login</li>
                        <li>GET ${API_BASE}/protected/contratante</li>
                        <li>GET ${API_BASE}/protected/profissional</li>
                        <li>GET ${API_BASE}/protected/admin</li>
                    </ul>
                    <p class="warning">⚠️ Verifique se estas rotas estão definidas no seu servidor.</p>
                `;
                configResult.classList.remove('hidden');
            });
            
            // Testar rota de autenticação
            testAuthBtn.addEventListener('click', async () => {
                apiTestResult.textContent = 'Testando rota de autenticação...';
                apiTestResult.className = 'result';
                apiTestResult.classList.remove('hidden');
                
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: 'testuser',
                            password: 'testpass'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.status === 401) {
                        apiTestResult.textContent = '✅ Rota de autenticação está funcionando (esperado erro de credenciais).';
                        apiTestResult.classList.add('success');
                    } else if (response.ok) {
                        apiTestResult.textContent = '✅ Rota de autenticação está funcionando perfeitamente!';
                        apiTestResult.classList.add('success');
                    } else {
                        apiTestResult.textContent = `❌ A rota de autenticação retornou um erro: ${data.message || response.status}`;
                        apiTestResult.classList.add('error');
                    }
                } catch (error) {
                    apiTestResult.innerHTML = `❌ Erro ao acessar rota de autenticação: <strong>${error.message}</strong>.
                    <br>Verifique se a rota /auth/login está definida no servidor.`;
                    apiTestResult.classList.add('error');
                }
            });
            
            // Testar rota protegida
            testProtectedBtn.addEventListener('click', async () => {
                apiTestResult.textContent = 'Testando rota protegida...';
                apiTestResult.className = 'result';
                apiTestResult.classList.remove('hidden');
                
                try {
                    const response = await fetch(`${API_BASE}/protected/contratante`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'user-role': 'Contratante'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        apiTestResult.textContent = '✅ Rota protegida está funcionando!';
                        apiTestResult.classList.add('success');
                    } else {
                        apiTestResult.textContent = `⚠️ Rota protegida retornou: ${data.message || response.status}`;
                        apiTestResult.classList.add('warning');
                    }
                } catch (error) {
                    apiTestResult.innerHTML = `❌ Erro ao acessar rota protegida: <strong>${error.message}</strong>.
                    <br>Verifique se a rota /protected/contratante está definida e se o CORS está configurado corretamente.`;
                    apiTestResult.classList.add('error');
                }
            });
        });
    </script>
</body>
</html>